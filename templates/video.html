{% extends 'layout.html' %}

{% block firstscript %}
{% endblock %}

{% block extraheaders %}
<link rel="stylesheet" href="/css/font-awesome.css" />
<link rel="stylesheet" href="/css/video.css" />
{% endblock %}

{% block content %}
{% if source %}
<p class="source"><a href="{{source}}">{{source}}</a></p>
<div id="status" ></div>
<div id="vid-window">
  <span class="fa fa-4x fa-pause icon"></span>
</div>
{% else %}
<div id="vid"><span class="fa fa-4x fa-pause icon"></span></div>
<div id="status" ><span class="timecode">00:00:00</span></div>
{% endif %}
{% endblock %}

{% block scripts %}
  {{import_script("jquery-1.11.1")}}
    <script src="/js/prod/shaka-player.js" type="text/javascript"></script>
<script type="text/javascript">
  var windowKeys = Object.keys(window);
</script>
<script type="text/javascript">
$('body').on('keydown', function(ev){
  'use strict';
  switch(ev.which){
    case 48: /* 0 key */
     $('video').each(function(){
       this.pause();
       this.src='';
       delete this.src;
       this.load();
       $(this).remove();
     });
    break;
  case 49: /* 1 key */
    window.open('','_self');
    window.close();
    break;
  case 415: /* 'play' RCU key */
    $('#vid').removeClass('paused');
    vid.play();
    break;
  case 19: /* 'pause' RCU key */
    $('#vid').addClass('paused');
    vid.pause();
    break;
  }
});
$(window).load(function(){
  'use strict'
  var player, src, vid, context, estimator, evname;
  var k;
  var statusEvents=['stalled','loadedmetadata', 'error', 'canplay', 'canplaythrough',
  'playing', 'ended', 'pause', 'resize', 'loadstart'];

  function genStatusFn(evName){
    return function(ev){
        var msg = new Date().toISOString()+': '+evName;
        $('#status').append('<p>'+msg+'</p>');
        console.log(msg);
        while($('#status > p').length>5){
            $('#status > p').first().remove();
        }
    };
  }

  vid = document.createElement('video');
  if(vid.canPlayType('{{mimeType}}')){
    src = document.createElement('source');
    src.setAttribute('type','{{mimeType}}');
    src.setAttribute('src','{{source}}');
    $(src).on('error', function(ev){
      console.error('playback failed');
      console.dir(ev);
    });
    $(vid).on('canplay',function(){ this.play(); });
    vid.appendChild(src);
    $('#vid-window').append(vid);
    vid.load();
  }
  else{
    /* fall-back to use Shaka JavaScript player */
    $('#vid-window').append(vid);
    shaka.polyfill.installAll();
    player = new shaka.player.Player(vid);
    player.addEventListener('error', function(ev){
      console.error('playback failed');
      console.dir(ev);
    });
    estimator = new shaka.util.EWMABandwidthEstimator();
    $(vid).on('canplay',function(){ this.play(); });
    player.load(new shaka.player.DashVideoSource('{{source}}', null, estimator));
  }
  for(k=0; k<statusEvents.length; ++k){
      evname = statusEvents[k];
      $(vid).on(evname, genStatusFn(evname));
  }
});
</script>
{% endblock %}
