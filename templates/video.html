{% extends 'layout.html' %}

{% block firstscript %}
{% endblock %}

{% block extraheaders %}
<link rel="stylesheet" href="/css/font-awesome.css" />
<link rel="stylesheet" href="/css/video.css" />
{% endblock %}

{% block content %}
{% if source %}
<p class="source"><a href="{{source}}">{{source}}</a></p>
<div id="vid-window">
	<span class="fa fa-4x fa-pause icon"></span>
</div>
{% else %}
<div id="vid"><span class="fa fa-4x fa-pause icon"></span></div>
<div id="status" class="status"><span class="timecode">00:00:00</span></div>
{% endif %}
{% endblock %}

{% block scripts %}
	{{import_script("jquery-1.11.1")}}
    <script src="/js/dash.all.js" type="text/javascript"></script>
<script type="text/javascript">
	var windowKeys = Object.keys(window);
</script>
<script type="text/javascript">
$('body').on('keydown', function(ev){
	'use strict';
	switch(ev.which){
		case 48: /* 0 key */
	 	$('video').each(function(){
	 		this.pause();
	 		this.src='';
	 		delete this.src;
	 		this.load();
	 		$(this).remove();
	 	});
		break;
	case 49: /* 1 key */
		window.open('','_self');
		window.close();
		break;
	case 415: /* 'play' RCU key */
		$('#vid').removeClass('paused');
		vid.play();
		break;
	case 19: /* 'pause' RCU key */
		$('#vid').addClass('paused');
		vid.pause();
		break;
	}
});
$(window).load(function(){
	var player, src, vid, context;
	var k, wk = Object.keys(window);
	for(k in wk){
		if(! (k in windowKeys)){
			console.log('new key '+k);
		}
	}
	vid = document.createElement('video');
	if(vid.canPlayType('{{mimeType}}')){
		src = document.createElement('source');
		src.setAttribute('type','{{mimeType}}');
		src.setAttribute('src','{{source}}');
		$(src).on('error', function(ev){
			console.error('playback failed');
			console.dir(ev);
		});
		$(vid).on('canplay',function(){ this.play(); });
		vid.appendChild(src);
		$('#vid-window').append(vid);
		vid.load();
	}
	else{
		/* fall-back to use DASH-IF JavaScript player */
		$('#vid-window').append(vid);
        context = new Dash.di.DashContext();
        player = new MediaPlayer(context);
        player.startup();
        player.attachView(vid);
        player.setAutoPlay(false);
        player.attachSource('{{source}}');
	}
});
</script>
{% endblock %}
