{% extends 'layout.html' %}


{% block content %}
<div id="media-management" class="container">
  <table class="table table-striped" id="streams">
    <caption>Streams</caption>
  <thead><tr><th>Title</th><th>Prefix</th><th /></tr></thead>
  <tbody>
    {% for stream in streams %}
    <tr>
      <td class="title">{{stream.title}}</td>
      <td class="prefix">{{stream.prefix}}</td>
      <td><button class="btn btn-danger delete-stream" data-id="{{stream.key.urlsafe()}}">Delete</button></td>
    </tr>
    {% endfor %}
    <tr class="placeholder"><td class="title"></td><td class="prefix"></td><td><button class="btn
    btn-danger delete-stream">Delete</button></td></tr>
  </tbody>
  <tfoot>
    <tr>
      <td><input type="text" name="title" placeholder="(stream title)"/></td>
      <td><input type="text" name="prefix" placeholder="(filename prefix)"/></td>
      <td><button class="btn btn-success add-stream">Add</button></td>
    </tr>
    <tr><td class="error" colspan="3"></td></tr>
    </tfoot>
</table>

  <table class="table table-striped" id="media-files">
    <caption>Media Files</caption>
  <thead>
    <tr>
      <th>Name</th>
      <th>Size</th>
      <th>Created</th>
      <th>Codec</th>
      <th>Encrypted</th>
      <th>KID</th>
      <th></th><th></th>
    </tr>
  </thead>
  <tbody>
    {% for med in media %}
    <tr>
      <td class="filename"><a href="{{uri_for("media-info", mfid=med.key)}}">{{med.name}}</a></td>
      <td class="filesize">
        {% if med.blob %}
        {{med.blob.size|sizeFormat}}
        {% else %}
        <span class="bool-no ">&cross;</span>
        {% endif %}
      </td>
      <td class="created">
        {% if med.blob %}
        {{med.blob.creation|dateTimeFormat("%H:%M:%S %d/%m/%Y")}}
        {% else %}
        <span class="bool-no ">&cross;</span>
        {% endif %}
      </td>
      <td class="codec">
        {% if med.representation %}
        {{med.representation.codecs}}
        {% endif %}
      </td>
      <td class="encrypted">
        {% if med.representation %}
          {% if med.representation.encrypted %}
            <span class="bool-yes ">&check;</span>
          {% else %}
            <span class="bool-no ">&cross;</span>
          {% endif %}
        {% else %}
          <span class="bool-unknown ">?</span>
        {% endif %}
      </td>
      <td class="kid">
        {% if med.representation %}
        {% if med.representation.encrypted %}
        {% for kid in med.representation.kids %}<p>{{kid}}</p>{% endfor %}
          {% endif %}
        {% endif %}
      </td>
      <td class="index">
        {% if med.representation %}
        <button class="btn btn-info btn-index" data-toggle="modal" data-target="#dialog-box"
                data-key="{{med.key}}">Re-index</button>
        {% else %}
        <button class="btn btn-warning btn-index" data-toggle="modal" data-target="#dialog-box"
                data-key="{{med.key}}">Index</button>
        {% endif %}
      </td>
      <td class="delete">
        {% if med.blob %}
        <button class="btn btn-danger btn-delete" data-key="{{med.key}}">Delete</button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    <tr><td class="error" colspan="4"></td></tr>
  </tbody>
</table>

  <table class="table table-striped" id="keys">
    <caption>Keys</caption>
  <thead><tr><th>KID</th><th>Key</th><th>Auto generated</th><th /></tr></thead>
  <tbody>
    {% for keypair in keys %}
    <tr>
      <td class="kid">{{keypair.KID.hex}}</td>
      <td class="key">{{keypair.KEY.hex}}</td>
      <td class="computed">
        {% if keypair.computed %}
        <span class="bool-yes %s">&check;</span>
        {% else %}
        <span class="bool-no ">&cross;</span>
        {% endif %}
      </td>
      <td><button class="btn btn-danger delete-key">Delete</button></td>
    </tr>
    {% endfor %}
    <tr class="placeholder"><td class="kid"></td><td class="key"></td><td class="computed"></td><td><button class="btn
    btn-danger delete-key">Delete</button></td></tr>
  </tbody>
  <tfoot>
    <tr>
      <td><input type="text" name="kid" /></td>
      <td><input type="text" name="key" placeholder="(autogenerated)"/></td>
      <td colspan="2"><button class="btn btn-success add-key">Add</button></td>
    </tr>
    <tr><td class="error" colspan="3"></td></tr>
    </tfoot>
</table>
	<form class="form" action="{{upload_url}}" method="POST"
              enctype="multipart/form-data" id="upload-form">
		{{csrf_token}}
    	Upload File: <input type="file" name="file" accept="video/mp4,audio/mp4,.mp4"><br />
    	<input type="submit" name="submit" value="Submit" class="btn btn-primary">
        </form>
</div>
<div class="modal" tabIndex="-1" role="dialog" id="dialog-box">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"></h5>
      <button type="button" class="close"
              data-dismiss="modal" aria-label="Close"
              onClick="closeDialog()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{import_script("jquery-3.4.1")}}
  {{import_script("bootstrap")}}
  <script src="/js/media.js" type="text/javascript"></script>
{% endblock %}
